---
- name: NCPA Linux Install
  # ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i [HOSTFILE] ncpa.yml --extra-vars "token=[NEWTOKEN]"
  hosts: all
  connection: ssh
  gather_facts: True
  remote_user: root
  tasks:

    - name: Download NCPA (Debian 64)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.d{{ ansible_distribution_major_version }}.amd64.deb dest=/tmp/ncpa.deb
      when: ansible_distribution == "Debian" and ansible_architecture == "x86_64"
    - name: Download NCPA (Debian 32)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.d{{ ansible_distribution_major_version }}.i386.deb dest=/tmp/ncpa.deb
      when: ansible_distribution == "Debian" and ansible_architecture == "i386"

    - name: Download NCPA (RedHat 64)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.el{{ ansible_distribution_major_version }}.x86_64.rpm dest=/tmp/ncpa.rpm
      when: ansible_os_family == "RedHat" and ansible_architecture == "x86_64"
    - name: Download NCPA (RedHat 32)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.el{{ ansible_distribution_major_version }}.i386.rpm dest=/tmp/ncpa.rpm
      when: ansible_os_family == "RedHat" and ansible_architecture == "i386"    

    - name: Download NCPA (Suse 11 64)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.os{{ ansible_distribution_major_version }}.x86_64.rpm dest=/tmp/ncpa.rpm
      when: ansible_os_family == "Suse" and ansible_architecture == "x86_64" and ansible_distribution_major_version|int == 11
    - name: Download NCPA (Suse 11 32)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.os{{ ansible_distribution_major_version }}.i386.rpm dest=/tmp/ncpa.rpm
      when: ansible_os_family == "Suse" and ansible_architecture == "i386" and ansible_distribution_major_version|int == 11
    - name: Download NCPA (Suse >=12)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.os.x86_64.rpm dest=/tmp/ncpa.rpm
      when: ansible_os_family == "Suse" and ansible_architecture == "x86_64" and ansible_distribution_major_version|int >= 12
    
    - name: Download NCPA (Ubuntu 64)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.amd64.deb dest=/tmp/ncpa.deb
      when: ansible_distribution == "Ubuntu" and ansible_architecture == "x86_64"
    - name: Download NCPA (Ubuntu 32)
      get_url: url=https://assets.nagios.com/downloads/ncpa/ncpa-latest.i386.deb dest=/tmp/ncpa.deb
      when: ansible_distribution == "Ubuntu" and ansible_architecture == "i386"

      
    - name: Install package (Debian & Ubuntu)
      apt:
        deb: /tmp/ncpa.deb
        state: present
      when: ansible_os_family == "Debian"

    - name: Install package (CentOS & RedHat)
      yum:
        name: /tmp/ncpa.rpm
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install package (SUSE and open SUSE)
      zypper:
        name: /tmp/ncpa.rpm
        disable_gpg_check: yes
        state: present
      when: ansible_os_family == "Suse"

      
    - name: Change token (all distros)
      lineinfile:
        dest: /usr/local/ncpa/etc/ncpa.cfg
        regexp: ^community_string
        line: "community_string = {{ token }}"      

      
    - name: Retart NCPA (apt/yum/zypper start on install, so we have to restart to catch the token update)
      service:
        name: ncpa_listener
        state: restarted
        enabled: yes


# Debian by default has no firewall, so this script doesn't need to open anything. If you run Debian and have a firewall scheme, you must modify this script to fit your scheme. If you use UFW, the Ubuntu section should be helpful.
# SuSE (once you enable eth0 to take connections) defaults to no restrictions on internal network traffic. If you are accessing SuSE machines from outside the internal network, or if you have internal network firewall settings, you must specifically allow traffic on 5693 for your environment.
        
    - name: open NCPA port (CentOS/RHEL 6)
      iptables:
        chain: INPUT
        jump: ACCEPT
        destination_port: 5693
        state: present
        protocol: tcp
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 6
 
    - name: save CentOS/RHEL 6 iptables change
      shell: service iptables save
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 6
 
    - name: open NCPA port (RedHat 7)
      firewalld:
        immediate: yes
        permanent: yes
        port: 5693
        state: enabled
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 7
      
    - name: open NCPA port (Ubuntu)
      ufw:
        state: enabled
        policy: allow
        proto: any
        rule: allow
        to_port: 5693
      when: ansible_distribution == "Ubuntu"